/**
 * Debug Spotify Authentication
 * Simple HTML page to test Spotify auth flow manually
 */

<!DOCTYPE html>
<html>
<head>
    <title>Test Spotify Auth</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .button { 
            padding: 12px 24px; 
            margin: 10px 0; 
            background: #1DB954; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            background: #f0f0f0;
        }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
    </style>
</head>
<body>
    <h1>[ICON] Epic Timeline - Spotify Auth Test</h1>
    
    <div id="status" class="status">
        <strong>Status:</strong> <span id="statusText">Ready to test</span>
    </div>
    
    <button class="button" onclick="testSpotifyAuth()">Test Spotify Authentication</button>
    <button class="button" onclick="checkAuthStatus()">Check Auth Status</button>
    <button class="button" onclick="clearAuth()">Clear Auth</button>
    
    <div id="logs" style="margin-top: 20px; font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px;">
        <strong>Debug Logs:</strong><br>
    </div>

    <script>
        const CLIENT_ID = '61ac86d247e9448ea2a9c5e7bd188055';
        const REDIRECT_URI = 'http://127.0.0.1:8081';
        
        function log(message) {
            const logs = document.getElementById('logs');
            logs.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`;
            console.log(message);
        }
        
        function updateStatus(text, isSuccess = false, isError = false) {
            const statusText = document.getElementById('statusText');
            const status = document.getElementById('status');
            statusText.textContent = text;
            
            status.className = 'status';
            if (isSuccess) status.className += ' success';
            if (isError) status.className += ' error';
        }
        
        function testSpotifyAuth() {
            log('[ICON] Starting Spotify authentication test...');
            updateStatus('Testing authentication...');
            
            const scopes = [
                'streaming',
                'user-read-email',
                'user-read-private',
                'user-read-playback-state'
            ];

            const params = new URLSearchParams({
                client_id: CLIENT_ID,
                response_type: 'token',
                redirect_uri: REDIRECT_URI,
                scope: scopes.join(' '),
                show_dialog: 'true'
            });

            const authUrl = `https://accounts.spotify.com/authorize?${params.toString()}`;
            log(`• Auth URL: ${authUrl.substring(0, 100)}...`);
            
            // Open auth window
            const authWindow = window.open(authUrl, 'spotify-auth', 'width=600,height=700,scrollbars=yes,resizable=yes');
            
            if (!authWindow) {
                log('✗ Popup blocked!');
                updateStatus('Popup blocked - please allow popups', false, true);
                return;
            }
            
            log('• Auth window opened, waiting for callback...');
            updateStatus('Auth window opened, waiting for user...');
            
            // Monitor the popup window
            let checkCount = 0;
            const checkInterval = setInterval(() => {
                checkCount++;
                
                try {
                    if (authWindow.closed) {
                        log('• Auth window closed by user');
                        clearInterval(checkInterval);
                        updateStatus('Auth window closed', false, true);
                        return;
                    }
                    
                    // Try to access the popup URL (will throw error if different origin)
                    const currentUrl = authWindow.location.href;
                    
                    if (currentUrl.includes('127.0.0.1:8081') && currentUrl.includes('access_token')) {
                        log('✓ Auth callback detected!');
                        clearInterval(checkInterval);
                        authWindow.close();
                        
                        // Parse the token from the URL
                        const hash = currentUrl.split('#')[1];
                        const params = new URLSearchParams(hash);
                        const token = params.get('access_token');
                        const expiresIn = params.get('expires_in');
                        
                        if (token) {
                            log(`• Token received: ${token.substring(0, 20)}...`);
                            log(`⏰ Expires in: ${expiresIn} seconds`);
                            
                            // Store token
                            localStorage.setItem('spotify_access_token', token);
                            localStorage.setItem('spotify_token_expiry', (Date.now() + (parseInt(expiresIn) * 1000)).toString());
                            
                            updateStatus('Authentication successful!', true);
                            testSpotifyAPI(token);
                        }
                    }
                } catch (e) {
                    // Expected - cross-origin restrictions
                }
                
                // Timeout after 30 seconds
                if (checkCount >= 150) { // 30 seconds / 200ms
                    log('⏰ Auth timeout');
                    clearInterval(checkInterval);
                    updateStatus('Authentication timeout', false, true);
                }
            }, 200);
        }
        
        async function testSpotifyAPI(token) {
            log('• Testing Spotify API with token...');
            
            try {
                // Test API call - search for "The Horse and the Infant"
                const searchUrl = `https://api.spotify.com/v1/search?q=${encodeURIComponent('The Horse and the Infant EPIC')}&type=track&limit=5`;
                
                const response = await fetch(searchUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`[ICON] Found ${data.tracks.items.length} tracks`);
                    
                    if (data.tracks.items.length > 0) {
                        const track = data.tracks.items[0];
                        log(`♪ First track: "${track.name}" by ${track.artists[0].name}`);
                        
                        if (track.preview_url) {
                            log(`♪ Preview URL available: ${track.preview_url.substring(0, 50)}...`);
                            updateStatus('API test successful - preview available!', true);
                        } else {
                            log('⚠ No preview URL available for this track');
                            updateStatus('API test successful - no preview for this track');
                        }
                    }
                } else {
                    log(`✗ API call failed: ${response.status} ${response.statusText}`);
                    updateStatus('API test failed', false, true);
                }
            } catch (error) {
                log(`✗ API test error: ${error.message}`);
                updateStatus('API test error', false, true);
            }
        }
        
        function checkAuthStatus() {
            const token = localStorage.getItem('spotify_access_token');
            const expiry = localStorage.getItem('spotify_token_expiry');
            
            if (token && expiry && parseInt(expiry) > Date.now()) {
                log(`✓ Valid token found: ${token.substring(0, 20)}...`);
                log(`⏰ Expires: ${new Date(parseInt(expiry)).toLocaleString()}`);
                updateStatus('Valid token found', true);
            } else {
                log('✗ No valid token found');
                updateStatus('No valid token', false, true);
            }
        }
        
        function clearAuth() {
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_token_expiry');
            log('• Auth cleared');
            updateStatus('Auth cleared');
        }
        
        // Check for callback on page load
        if (window.location.hash.includes('access_token')) {
            log('↻ Detected auth callback on page load');
            setTimeout(testSpotifyAuth, 1000);
        }
        
        log('[ICON] Spotify auth tester loaded');
        log(`• Client ID: ${CLIENT_ID}`);
        log(`• Redirect URI: ${REDIRECT_URI}`);
    </script>
</body>
</html>
